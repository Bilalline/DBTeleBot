# DBTeleBot

Telegram бот для анализа сообщений из группы и сохранения их в MediaWiki с использованием внешнего сервера Ollama.

## Описание

DBTeleBot - это асинхронный бот, который:
- Подключается к Telegram от имени пользователя (не бота)
- Анализирует сообщения из указанной группы с помощью внешнего сервера Ollama
- Сохраняет проанализированные сообщения в MediaWiki
- Ведет подробное логирование всех операций

## Компоненты

### База данных (SQLite)
- Асинхронная работа с SQLite
- Хранение информации о сообщениях и их статусе обработки
- Отслеживание обработанных сообщений

### MediaWiki клиент
- Асинхронное взаимодействие с MediaWiki API
- Авторизация и управление страницами
- Создание и обновление контента

### Ollama клиент
- Взаимодействие с внешним сервером Ollama
- Анализ текста сообщений
- Извлечение ключевой информации

### Основной бот
- Подключение к Telegram от имени пользователя
- Обработка сообщений из группы
- Управление всеми компонентами

## Развертывание

### Требования
- Python 3.11+
- Docker и Docker Compose
- Доступ к внешнему серверу Ollama
- Учетная запись Telegram пользователя
- Доступ к MediaWiki

### Переменные окружения
```env
# Telegram
TELEGRAM_API_ID=your_api_id
TELEGRAM_API_HASH=your_api_hash
TELEGRAM_PHONE=your_phone
ADMIN_ID=your_admin_id
GROUP_ID=your_group_id

# MediaWiki
WIKI_USERNAME=your_username
WIKI_PASSWORD=your_password
WIKI_SITE=your_wiki_url

# Ollama
OLLAMA_URL=http://your_ollama_server:11434
OLLAMA_MODEL=your_model_name
```

### Подготовка к запуску

1. Создайте файл `.env` с необходимыми переменными окружения

2. Создайте сессию Telegram:
   ```bash
   # Установите зависимости
   pip install -r requirements.txt
   
   # Запустите скрипт генерации сессии
   python generate_session.py
   ```
   - Введите номер телефона
   - Введите код подтверждения из Telegram
   - Сессия будет сохранена в `session/session.session`

3. Убедитесь, что внешний сервер Ollama доступен по указанному URL

4. Проверьте доступность MediaWiki

### Запуск с помощью Docker Compose

1. Соберите и запустите контейнер:
   ```bash
   docker-compose up -d
   ```

2. Проверьте логи:
   ```bash
   docker-compose logs -f
   ```

## Структура проекта
```
.
├── app/
│   ├── main.py           # Основной код бота
│   ├── database.py       # Работа с базой данных
│   ├── wiki_client.py    # Клиент MediaWiki
│   └── ollama_client.py  # Клиент Ollama
├── session/             # Директория для сессий Telegram
├── logs/               # Директория для логов
├── data/              # Директория для данных
├── generate_session.py # Скрипт для создания сессии Telegram
├── Dockerfile
├── docker-compose.yml
├── requirements.txt
└── README.md
```

## Логирование

Логи сохраняются в директории `logs/`:
- `bot.log` - основной лог бота
- Ротация логов происходит ежедневно
- Хранение логов - 7 дней

## Известные проблемы и решения

### Подключение к Telegram
- Бот работает от имени пользователя, а не бота
- Требуется валидная сессия Telegram в файле `session/session.session`
- При отсутствии сессии используйте `generate_session.py`

### Подключение к Ollama
- Используется внешний сервер Ollama
- Убедитесь, что сервер доступен по указанному URL
- Проверьте доступность указанной модели

### Подключение к супергруппе
- Бот использует `PeerChannel` для работы с супергруппами
- ID группы должен быть отрицательным числом
- Убедитесь, что у пользователя есть доступ к группе

## Лицензия

MIT

## Автор

Ваше имя 